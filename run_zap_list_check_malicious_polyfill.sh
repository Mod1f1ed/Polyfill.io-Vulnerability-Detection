#!/bin/bash

# Check if a file with URLs is provided
if [ -z "$1" ]; then
  echo "Usage: $0 <file_with_urls>"
  exit 1
fi

# Loop through each URL in the file
while IFS= read -r url; do
  if [ ! -z "$url" ]; then
    # Add https:// if not present
    if [[ ! "$url" =~ ^https?:// ]]; then
      url="https://$url"
    fi

    echo "Running ZAP scan for $url"
    
    # Run the ZAP baseline scan and capture the output
    output=$(sudo docker run -t zaproxy/zap-stable zap-baseline.py -t "$url")

    # Check for the specific warning related to polyfill
    if echo "$output" | grep -iq "WARN-NEW: Script Served From Malicious Domain (polyfill)"; then
      echo "WARNING: Polyfill script from a malicious domain detected on $url"
    else
      echo "No malicious polyfill script detected on $url"
    fi

    # Save the output to a file for further analysis
    echo "$output" > "zap_output_$(echo $url | sed 's/[:\/]/_/g').txt"
  fi
done < "$1"
